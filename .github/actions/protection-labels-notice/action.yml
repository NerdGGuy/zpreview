name: 'Protection Labels and Notice'
description: 'Applies protection labels and creates notices for protected content'

inputs:
  token:
    description: 'GitHub token'
    required: true
  issue-number:
    description: 'Issue number'
    required: true
  repo-owner:
    description: 'Repository owner'
    required: true
  repo-name:
    description: 'Repository name'
    required: true
  pr-number:
    description: 'Pull request number'
    required: true

runs:
  using: "composite"
  steps:
    - name: Check and Apply Protection Labels
      uses: actions/github-script@v7
      env:
        REPO_OWNER: ${{ inputs.repo-owner }}
        REPO_NAME: ${{ inputs.repo-name }}
        ISSUE_NUMBER: ${{ inputs.issue-number }}
        PR_NUMBER: ${{ inputs.pr-number }}
      with:
        github-token: ${{ inputs.token }}
        script: |
          const { REPO_OWNER, REPO_NAME, ISSUE_NUMBER, PR_NUMBER } = process.env
          
          const issue = await github.rest.issues.get({
            owner: REPO_OWNER,
            repo: REPO_NAME, 
            issue_number: ISSUE_NUMBER
          });
          
          const hasProtectionLabel = issue.data.labels.some(label => 
            label.name === 'content-protected'
          );
          
          if (!hasProtectionLabel) {
            await github.rest.issues.addLabels({
              owner: REPO_OWNER,
              repo: REPO_NAME,
              issue_number: ISSUE_NUMBER,
              labels: ['content-protected']
            });

            // Call the ZCG grant notice action directly if no protection label exists
            await github.rest.issues.createComment({
              owner: REPO_OWNER,
              repo: REPO_NAME,
              issue_number: ISSUE_NUMBER,
              body: inputs.notice_message || 'Protected content notice'
            });
          }

    - name: Post ZCG Grant Notice
      uses: ./.github/actions/zcg-grant-notice
      with:
        token: ${{ inputs.token }}
        issue-number: ${{ inputs.issue-number }}
        repo-owner: ${{ inputs.repo-owner }}
        repo-name: ${{ inputs.repo-name }}

    - name: Create Change Notice
      if: github.event_name == 'issues' && github.event.action == 'edited'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.token }}
        script: |
          const changeNotice = `## ⚠️ Content Change Detected

          The protected content of this issue has been modified.
          - The existing snapshot PR has been updated
          - Maintainers will review these changes
          
          @${REPO_OWNER} Please review these changes.`;

          await github.rest.issues.createComment({
            owner: REPO_OWNER,
            repo: REPO_NAME,
            issue_number: ISSUE_NUMBER,
            body: changeNotice
          });
